name: CI

on:
  push:
    branches: [master, main]
    tags: [v*]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  commit-message-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Lint commit messages for literal '\\n' outside quoted examples
        run: |
          set -euo pipefail
          # Get last 200 commit bodies
          commits=$(git log -n 200 --pretty=%B)
          if ! echo "$commits" | grep -q "\\\n"; then
            echo "No literal '\\n' sequences found in commit messages."
            exit 0
          fi
          # For each line containing a literal \n, ensure it's part of a quoted example like '\n' or "\n" or `\n`
          echo "$commits" | nl -ba -v 1 | sed -n '1,200p' | while read -r num line; do
            if echo "$line" | grep -q "\\\\n"; then
              # allow if line contains quoted '\n', "\n", or `\n`
              if echo "$line" | grep -q -E "'\\\\n'|\"\\\\n\"|`\\\\n`"; then
                continue
              fi
              echo "Found literal '\\n' not in quotes in commit message (line $num):"
              echo "$line"
              echo "Please use real newlines in commit messages or wrap '\\n' in quotes when referring to the two-character sequence."
              echo "See .github/copilot-instructions.md for guidance."
              exit 1
            fi
          done
  # Linux native build and test
  build-linux:
    runs-on: ubuntu-latest
    needs: [commit-message-lint, docs-and-includes-check, format-check]
    env:
      DEDU_ARCHIVE_ROOT: "${{ github.workspace }}/ARCHIVE4"
    strategy:
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # MinVer needs full history

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libacl1-dev attr zip

      - name: Create archive root
        run: |
          mkdir -p "${{ env.DEDU_ARCHIVE_ROOT }}"

      - name: Restore dependencies
        run: dotnet restore
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}-${{ matrix.configuration }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: Cache native build (OsCallsWindowsShim)
        uses: actions/cache@v4
        with:
          path: OsCallsWindowsShim/build-win-x64
          key: ${{ runner.os }}-cmake-oscallswinshim-${{ matrix.configuration }}-${{ hashFiles('OsCallsWindowsShim/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-oscallswinshim-${{ matrix.configuration }}-
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}-${{ matrix.configuration }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: Cache native build (OsCallsCommonShim)
        uses: actions/cache@v4
        with:
          path: OsCallsCommonShim/build/${{ matrix.configuration }}
          key: ${{ runner.os }}-cmake-oscallscshim-${{ matrix.configuration }}-${{ hashFiles('OsCallsCommonShim/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-oscallscshim-${{ matrix.configuration }}-
      - name: Cache native build (OsCallsLinuxShim)
        uses: actions/cache@v4
        with:
          path: OsCallsLinuxShim/build/${{ matrix.configuration }}
          key: ${{ runner.os }}-cmake-oscallslshim-${{ matrix.configuration }}-${{ hashFiles('OsCallsLinuxShim/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-oscallslshim-${{ matrix.configuration }}-

      - name: Build DeDuBa project (Linux)
        run: dotnet build DeDuBa/DeDuBa.csproj --configuration ${{ matrix.configuration }} --no-restore -r linux-x64

      - name: Enable native debug logs (Linux)
        if: always()
        run: |
          echo "DEDUBA_DEBUG_NATIVE=1" >> $GITHUB_ENV

      - name: Print loader environment variables (Linux)
        if: always()
        run: |
          echo "==== LD_LIBRARY_PATH ===="
          echo "$LD_LIBRARY_PATH"
          echo "==== PATH ===="
          echo "$PATH"

      - name: Run tests
        run: dotnet test DeDuBa.Test/DeDuBa.Test.csproj --configuration ${{ matrix.configuration }} --verbosity normal -r linux-x64
        env:
          LD_LIBRARY_PATH: "${{ github.workspace }}/OsCallsCommonShim/bin/${{ matrix.configuration }}/net8.0:${{ github.workspace }}/OsCallsLinuxShim/bin/${{ matrix.configuration }}/net8.0"
          DEDU_ARCHIVE_ROOT: "${{ env.DEDU_ARCHIVE_ROOT }}"

      - name: Package Linux artifacts
        if: matrix.configuration == 'Release'
        run: |
          chmod +x scripts/package.sh
          scripts/package.sh linux-x64 ${{ matrix.configuration }}

      - name: Upload Linux artifacts
        if: matrix.configuration == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: DeDuBa-linux-x64-${{ matrix.configuration }}
          path: |
            dist/DeDuBa-*-linux-x64.tar.gz
            dist/DeDuBa-*-linux-x64.tar.gz.sha512
          retention-days: 30

  # Windows cross-build (MinGW on Linux)
  build-windows-cross:
    runs-on: ubuntu-latest
    needs: [commit-message-lint, docs-and-includes-check, format-check]
    env:
      DEDU_ARCHIVE_ROOT: "${{ github.workspace }}/ARCHIVE4"
    strategy:
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install cross-compile dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build mingw-w64 zip

      - name: Create archive root
        run: |
          mkdir -p "${{ env.DEDU_ARCHIVE_ROOT }}"

      - name: Restore dependencies
        run: dotnet restore
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}-${{ matrix.configuration }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: Cache native build (OsCallsWindowsShim)
        uses: actions/cache@v4
        with:
          path: OsCallsWindowsShim/build-win-x64/bin
          key: ${{ runner.os }}-cmake-oscallswinshim-${{ matrix.configuration }}-${{ hashFiles('OsCallsWindowsShim/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-oscallswinshim-${{ matrix.configuration }}-

      - name: Enable native debug logs (cross build)
        if: always()
        run: |
          echo "DEDUBA_DEBUG_NATIVE=1" >> $GITHUB_ENV

      - name: Print loader environment variables (cross build)
        if: always()
        run: |
          echo "==== LD_LIBRARY_PATH ===="
          echo "$LD_LIBRARY_PATH"
          echo "==== PATH ===="
          echo "$PATH"

      - name: Build Windows shim (cross)
        run: |
          dotnet build OsCallsWindowsShim/OsCallsWindowsShim.csproj \
            --configuration ${{ matrix.configuration }} \
            -r win-x64

      - name: Package Windows artifacts
        if: matrix.configuration == 'Release'
        run: |
          chmod +x scripts/package.sh
          scripts/package.sh win-x64 ${{ matrix.configuration }}

      - name: Upload Windows artifacts
        if: matrix.configuration == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: DeDuBa-win-x64-${{ matrix.configuration }}
          path: |
            dist/DeDuBa-*-win-x64.zip
            dist/DeDuBa-*-win-x64.zip.sha512
          retention-days: 30

  # Native Windows build and test (validates on actual Windows)
  build-windows-native:
    runs-on: windows-latest
    needs: [commit-message-lint, docs-and-includes-check, format-check]
    env:
      DEDU_ARCHIVE_ROOT: "${{ github.workspace }}/ARCHIVE4"
    strategy:
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Create archive root (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "${{ env.DEDU_ARCHIVE_ROOT }}" | Out-Null

      - name: Debug CMake & project layout (Windows)
        shell: pwsh
        run: |
          Write-Host "=== Windows CI diagnostics ==="
          Write-Host "PWD: $(Get-Location)"
          Write-Host "--- cmake info ---"
          if (Get-Command cmake -ErrorAction SilentlyContinue) {
            cmake --version
          } else {
            Write-Host "cmake not found in PATH"
          }
          Write-Host "--- Directory listing (root of repo) ---"
          Get-ChildItem -Force | Select-Object Name,Mode,Length | Sort-Object Name | Format-Table -AutoSize
          Write-Host "--- Check OsCallsWindowsShim folder and CMakeLists.txt ---"
          if (Test-Path OsCallsWindowsShim) {
            Write-Host "OsCallsWindowsShim directory exists"
            if (Test-Path OsCallsWindowsShim/CMakeLists.txt) {
              Write-Host "CMakeLists.txt found"
            } else {
              Write-Host "CMakeLists.txt is missing in OsCallsWindowsShim"
            }
            Write-Host "Listing OsCallsWindowsShim top-level files"
            Get-ChildItem OsCallsWindowsShim | Select-Object Name,Mode,Length | Format-Table -AutoSize
          } else {
            Write-Host "OsCallsWindowsShim directory does not exist"
          }
          Write-Host "=== End diagnostics ==="

      - name: Show native build folder (Windows)
        shell: pwsh
        run: |
          Write-Host "--- Showing OsCallsWindowsShim/build-win-x64 ---"
          if (Test-Path OsCallsWindowsShim/build-win-x64) {
            Get-ChildItem OsCallsWindowsShim/build-win-x64 | Select-Object Name,Mode,Length | Format-Table -AutoSize
          } else {
            Write-Host "OsCallsWindowsShim/build-win-x64 not present"
          }

      - name: Build OsCallsWindowsShim project (Windows) # Diagnostic
        shell: pwsh
        run: |
          Write-Host "=== Building OsCallsWindowsShim project for diagnostics ==="
          dotnet build OsCallsWindowsShim/OsCallsWindowsShim.csproj --configuration ${{ matrix.configuration }} -r win-x64 -v minimal

      - name: Build DeDuBa project (Windows)
        run: dotnet build DeDuBa/DeDuBa.csproj --configuration ${{ matrix.configuration }} --no-restore -r win-x64

      - name: Enable native debug logs (Windows)
        if: always()
        shell: pwsh
        run: |
          Write-Host "Setting DEDUBA_DEBUG_NATIVE=1 for subsequent steps"
          echo "DEDUBA_DEBUG_NATIVE=1" >> $env:GITHUB_ENV

      - name: Print loader environment variables (Windows)
        if: always()
        shell: pwsh
        run: |
          Write-Host "==== PATH ===="
          Write-Host $env:PATH
          Write-Host "==== LD_LIBRARY_PATH (if present) ===="
          Write-Host $env:LD_LIBRARY_PATH

      - name: Run tests (Windows)
        run: dotnet test DeDuBa.Test/DeDuBa.Test.csproj --configuration ${{ matrix.configuration }} --verbosity normal -r win-x64
        env:
          DEDU_ARCHIVE_ROOT: "${{ env.DEDU_ARCHIVE_ROOT }}"

      - name: Smoke test Windows binary
        if: matrix.configuration == 'Release'
        shell: pwsh
        run: |
          dotnet publish DeDuBa/DeDuBa.csproj `
            --configuration ${{ matrix.configuration }} `
            -r win-x64 `
            -p:PublishSingleFile=true `
            -p:SelfContained=true `
            -o dist/smoke-test

          # Try --version to ensure runtime loads
          dist/smoke-test/DeDuBa.exe --help || echo "Help output returned non-zero (expected if no args required)"

  # Doxygen check and Platform.h header validation
  docs-and-includes-check:
    runs-on: ubuntu-latest
    needs: [commit-message-lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz
      - name: Run Doxygen + Platform.h include checks
        run: |
          python3 scripts/check_doxygen_and_platform_header.py

  # Formatting check to ensure clang-format is applied to tracked C/C++ files
  format-check:
    runs-on: ubuntu-latest
    needs: [commit-message-lint, docs-and-includes-check]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format
      - name: Check formatting
        run: |
          set -euo pipefail
          # Fail if clang-format would modify any tracked C/C++ files
          git ls-files -z "*.h" "*.hpp" "*.c" "*.cpp" "*.cc" "*.cxx" "*.hh" | xargs -0 -r clang-format --dry-run -Werror

  # Consolidate artifacts and prepare for release (runs only on Release builds)
  prepare-release:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    needs: [build-linux, build-windows-cross]
    runs-on: ubuntu-latest
    env:
      DEDU_ARCHIVE_ROOT: "${{ github.workspace }}/ARCHIVE4"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -lR artifacts/

      - name: Archive consolidated artifacts
        run: |
          mkdir -p release-staging
          find artifacts/ -name '*.tar.gz' -exec cp {} release-staging/ \;
          find artifacts/ -name '*.zip' -exec cp {} release-staging/ \;
          ls -lh release-staging/

      - name: Setup .NET for version detection
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Generate release metadata
        run: |
          set -euo pipefail
          mkdir -p release-staging
          version=$(dotnet msbuild DeDuBa/DeDuBa.csproj -nologo -t:MinVer -getProperty:MinVerVersion 2>/dev/null || echo "0.0.0-unknown")
          commit="${{ github.sha }}"
          ref="${{ github.ref }}"
          run_id="${{ github.run_id }}"
          config="Release"
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          dedu_archive_root="${{ env.DEDU_ARCHIVE_ROOT }}"
          meta_file=release-staging/release-metadata.json
          echo "{\n  \"version\": \"${version}\",\n  \"git_commit\": \"${commit}\",\n  \"git_ref\": \"${ref}\",\n  \"ci_run_id\": \"${run_id}\",\n  \"build_config\": \"${config}\",\n  \"timestamp_utc\": \"${ts}\",\n  \"dedu_archive_root\": \"${dedu_archive_root}\"," > ${meta_file}
          echo "  \"artifacts\": [" >> ${meta_file}
          for f in release-staging/*.{tar.gz,zip}; do
            [ -e "${f}" ] || continue
            # prefer any precomputed sha512, otherwise compute
            sha_file="${f}.sha512"
            if [ -f "${sha_file}" ]; then
              sha=$(awk '{print $1}' "${sha_file}")
            else
              sha=$(sha512sum "${f}" | awk '{print $1}')
            fi
            echo "    { \"path\": \"$(basename "${f}")\", \"sha512\": \"${sha}\" }," >> ${meta_file}
          done
          # remove trailing comma and finalize JSON
          sed -i '$ s/,$//' ${meta_file}
          echo "  ]\n}" >> ${meta_file}
          echo "Generated metadata:"
          cat ${meta_file}

      - name: Upload consolidated release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DeDuBa-release-all
          path: release-staging/
          retention-days: 90

  # Create GitHub release from artifacts (only on version tags)
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-windows-cross, build-windows-native]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find artifacts/ -name '*.tar.gz' -exec cp {} release-files/ \;
          find artifacts/ -name '*.zip' -exec cp {} release-files/ \;
          # Also include checksum files
          find artifacts/ -name '*.sha512' -exec cp {} release-files/ \;
          # Include release metadata if present
          if [ -f artifacts/release-staging/release-metadata.json ]; then
            cp artifacts/release-staging/release-metadata.json release-files/
          fi
          echo "=== Release files ==="
          ls -lh release-files/

      - name: Verify release artifact checksums
        run: |
          set -euo pipefail
          if ! command -v python3 >/dev/null 2>&1; then
            echo 'python3 not available; skip checksum verification' && exit 0
          fi
          python3 scripts/verify-release-checksums.py --meta release-files/release-metadata.json --dir release-files

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true
          body: |
            ## Downloads

            ### Linux (x64)
            - `DeDuBa-*-linux-x64.tar.gz` - Self-contained Linux binary with native POSIX shims
              - Extract: `tar xzf DeDuBa-*-linux-x64.tar.gz`
              - Run: `./DeDuBa <files-to-backup>`

            ### Windows (x64)
            - `DeDuBa-*-win-x64.zip` - Self-contained Windows binary with native shims
              - Extract to a folder and run `DeDuBa.exe <files-to-backup>`

            ## What's Changed

            See below for automatically generated release notes from commit messages.
            For detailed changes, see [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/docs/CHANGELOG.md).

            ---
