name: CI

on:
  push:
    branches: [master, main]
    tags: ["v*"]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  commit-message-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Lint commit messages for literal '\\n'
        run: |
          set -euo pipefail
          # Examine last 200 commit bodies and fail if a literal '\n' sequence appears
          if git log -n 200 --pretty=%B | grep -F "\\n" >/dev/null; then
            echo "Found literal '\\n' string in commit message(s). Please use real newlines in commit messages."
            echo "See .github/copilot-instructions.md for guidance."
            git log -n 200 --pretty=format:'%h %s%n%b' | sed -n '1,200p' | awk '/\\\\n/ {print; exit 0}' || true
            exit 1
          fi
  # Linux native build and test
  build-linux:
    runs-on: ubuntu-latest
    needs: [commit-message-lint]
    env:
      DEDU_ARCHIVE_ROOT: "${{ github.workspace }}/ARCHIVE4"
    strategy:
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # MinVer needs full history

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libacl1-dev attr zip

      - name: Create archive root
        run: |
          mkdir -p "${{ env.DEDU_ARCHIVE_ROOT }}"

      - name: Restore dependencies
        run: dotnet restore
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}-${{ matrix.configuration }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: Cache native build (OsCallsWindowsShim)
        uses: actions/cache@v4
        with:
          path: OsCallsWindowsShim/build-win-x64
          key: ${{ runner.os }}-cmake-oscallswinshim-${{ matrix.configuration }}-${{ hashFiles('OsCallsWindowsShim/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-oscallswinshim-${{ matrix.configuration }}-
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}-${{ matrix.configuration }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: Cache native build (OsCallsCommonShim)
        uses: actions/cache@v4
        with:
          path: OsCallsCommonShim/build/${{ matrix.configuration }}
          key: ${{ runner.os }}-cmake-oscallscshim-${{ matrix.configuration }}-${{ hashFiles('OsCallsCommonShim/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-oscallscshim-${{ matrix.configuration }}-
      - name: Cache native build (OsCallsLinuxShim)
        uses: actions/cache@v4
        with:
          path: OsCallsLinuxShim/build/${{ matrix.configuration }}
          key: ${{ runner.os }}-cmake-oscallslshim-${{ matrix.configuration }}-${{ hashFiles('OsCallsLinuxShim/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-oscallslshim-${{ matrix.configuration }}-

      - name: Build DeDuBa project (Linux)
        run: dotnet build DeDuBa/DeDuBa.csproj --configuration ${{ matrix.configuration }} --no-restore -r linux-x64

      - name: Run tests
        run: dotnet test DeDuBa.Test/DeDuBa.Test.csproj --configuration ${{ matrix.configuration }} --verbosity normal -r linux-x64
        env:
          LD_LIBRARY_PATH: "${{ github.workspace }}/OsCallsCommonShim/bin/${{ matrix.configuration }}/net8.0:${{ github.workspace }}/OsCallsLinuxShim/bin/${{ matrix.configuration }}/net8.0"
          DEDU_ARCHIVE_ROOT: "${{ env.DEDU_ARCHIVE_ROOT }}"

      - name: Package Linux artifacts
        if: matrix.configuration == 'Release'
        run: |
          chmod +x scripts/package.sh
          scripts/package.sh linux-x64 ${{ matrix.configuration }}

      - name: Upload Linux artifacts
        if: matrix.configuration == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: DeDuBa-linux-x64-${{ matrix.configuration }}
          path: |
            dist/DeDuBa-*-linux-x64.tar.gz
            dist/DeDuBa-*-linux-x64.tar.gz.sha512
          retention-days: 30

  # Windows cross-build (MinGW on Linux)
  build-windows-cross:
    runs-on: ubuntu-latest
    needs: [commit-message-lint]
    env:
      DEDU_ARCHIVE_ROOT: "${{ github.workspace }}/ARCHIVE4"
    strategy:
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install cross-compile dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build mingw-w64 zip

      - name: Create archive root
        run: |
          mkdir -p "${{ env.DEDU_ARCHIVE_ROOT }}"

      - name: Restore dependencies
        run: dotnet restore
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}-${{ matrix.configuration }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: Cache native build (OsCallsWindowsShim)
        uses: actions/cache@v4
        with:
          path: OsCallsWindowsShim/build-win-x64/bin
          key: ${{ runner.os }}-cmake-oscallswinshim-${{ matrix.configuration }}-${{ hashFiles('OsCallsWindowsShim/**') }}
          restore-keys: |
            ${{ runner.os }}-cmake-oscallswinshim-${{ matrix.configuration }}-

      - name: Build Windows shim (cross)
        run: |
          dotnet build OsCallsWindowsShim/OsCallsWindowsShim.csproj \
            --configuration ${{ matrix.configuration }} \
            -r win-x64

      - name: Package Windows artifacts
        if: matrix.configuration == 'Release'
        run: |
          chmod +x scripts/package.sh
          scripts/package.sh win-x64 ${{ matrix.configuration }}

      - name: Upload Windows artifacts
        if: matrix.configuration == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: DeDuBa-win-x64-${{ matrix.configuration }}
          path: |
            dist/DeDuBa-*-win-x64.zip
            dist/DeDuBa-*-win-x64.zip.sha512
          retention-days: 30

  # Native Windows build and test (validates on actual Windows)
  build-windows-native:
    runs-on: windows-latest
    needs: [commit-message-lint]
    env:
      DEDU_ARCHIVE_ROOT: "${{ github.workspace }}/ARCHIVE4"
    strategy:
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Create archive root (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "${{ env.DEDU_ARCHIVE_ROOT }}" | Out-Null

      - name: Build DeDuBa project (Windows)
        run: dotnet build DeDuBa/DeDuBa.csproj --configuration ${{ matrix.configuration }} --no-restore -r win-x64

      - name: Run tests (Windows)
        run: dotnet test DeDuBa.Test/DeDuBa.Test.csproj --configuration ${{ matrix.configuration }} --verbosity normal -r win-x64
        env:
          DEDU_ARCHIVE_ROOT: "${{ env.DEDU_ARCHIVE_ROOT }}"

      - name: Smoke test Windows binary
        if: matrix.configuration == 'Release'
        shell: pwsh
        run: |
          dotnet publish DeDuBa/DeDuBa.csproj `
            --configuration ${{ matrix.configuration }} `
            -r win-x64 `
            -p:PublishSingleFile=true `
            -p:SelfContained=true `
            -o dist/smoke-test

          # Try --version to ensure runtime loads
          dist/smoke-test/DeDuBa.exe --help || echo "Help output returned non-zero (expected if no args required)"

  # Consolidate artifacts and prepare for release (runs only on Release builds)
  prepare-release:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    needs: [build-linux, build-windows-cross]
    runs-on: ubuntu-latest
    env:
      DEDU_ARCHIVE_ROOT: "${{ github.workspace }}/ARCHIVE4"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -lR artifacts/

      - name: Archive consolidated artifacts
        run: |
          mkdir -p release-staging
          find artifacts/ -name '*.tar.gz' -exec cp {} release-staging/ \;
          find artifacts/ -name '*.zip' -exec cp {} release-staging/ \;
          ls -lh release-staging/

      - name: Setup .NET for version detection
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Generate release metadata
        run: |
          set -euo pipefail
          mkdir -p release-staging
          version=$(dotnet msbuild DeDuBa/DeDuBa.csproj -nologo -t:MinVer -getProperty:MinVerVersion 2>/dev/null || echo "0.0.0-unknown")
          commit="${{ github.sha }}"
          ref="${{ github.ref }}"
          run_id="${{ github.run_id }}"
          config="Release"
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          dedu_archive_root="${{ env.DEDU_ARCHIVE_ROOT }}"
          meta_file=release-staging/release-metadata.json
          echo "{\n  \"version\": \"${version}\",\n  \"git_commit\": \"${commit}\",\n  \"git_ref\": \"${ref}\",\n  \"ci_run_id\": \"${run_id}\",\n  \"build_config\": \"${config}\",\n  \"timestamp_utc\": \"${ts}\",\n  \"dedu_archive_root\": \"${dedu_archive_root}\"," > ${meta_file}
          echo "  \"artifacts\": [" >> ${meta_file}
          for f in release-staging/*.{tar.gz,zip}; do
            [ -e "${f}" ] || continue
            # prefer any precomputed sha512, otherwise compute
            sha_file="${f}.sha512"
            if [ -f "${sha_file}" ]; then
              sha=$(awk '{print $1}' "${sha_file}")
            else
              sha=$(sha512sum "${f}" | awk '{print $1}')
            fi
            echo "    { \"path\": \"$(basename "${f}")\", \"sha512\": \"${sha}\" }," >> ${meta_file}
          done
          # remove trailing comma and finalize JSON
          sed -i '$ s/,$//' ${meta_file}
          echo "  ]\n}" >> ${meta_file}
          echo "Generated metadata:"
          cat ${meta_file}

      - name: Upload consolidated release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DeDuBa-release-all
          path: release-staging/
          retention-days: 90

  # Create GitHub release from artifacts (only on version tags)
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-windows-cross, build-windows-native]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find artifacts/ -name '*.tar.gz' -exec cp {} release-files/ \;
          find artifacts/ -name '*.zip' -exec cp {} release-files/ \;
          # Also include checksum files
          find artifacts/ -name '*.sha512' -exec cp {} release-files/ \;
          # Include release metadata if present
          if [ -f artifacts/release-staging/release-metadata.json ]; then
            cp artifacts/release-staging/release-metadata.json release-files/
          fi
          echo "=== Release files ==="
          ls -lh release-files/

      - name: Verify release artifact checksums
        run: |
          set -euo pipefail
          # Install jq to parse the metadata JSON
          sudo apt-get update
          sudo apt-get install -y jq
          meta='release-files/release-metadata.json'
          if [ ! -f "${meta}" ]; then
            echo "No release metadata found; skipping verification"
            exit 0
          fi
          jq -r '.artifacts[] | "\(.path) \(.sha512)"' "${meta}" | while read -r path sha; do
            p="release-files/${path}"
            if [ ! -f "${p}" ]; then
              echo "Missing artifact: ${p}" >&2
              exit 1
            fi
            actual=$(sha512sum "${p}" | awk '{print $1}')
            if [ "${actual}" != "${sha}" ]; then
              echo "Checksum mismatch for ${path}: expected ${sha}, got ${actual}" >&2
              exit 1
            fi
          done
          echo "Artifact checksum verification passed"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true
          body: |
            ## Downloads

            ### Linux (x64)
            - `DeDuBa-*-linux-x64.tar.gz` - Self-contained Linux binary with native POSIX shims
              - Extract: `tar xzf DeDuBa-*-linux-x64.tar.gz`
              - Run: `./DeDuBa <files-to-backup>`

            ### Windows (x64)
            - `DeDuBa-*-win-x64.zip` - Self-contained Windows binary with native shims
              - Extract to a folder and run `DeDuBa.exe <files-to-backup>`

            ## What's Changed

            See below for automatically generated release notes from commit messages.
            For detailed changes, see [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/docs/CHANGELOG.md).

            ---
