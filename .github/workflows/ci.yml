name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  # Linux native build and test
  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # MinVer needs full history

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build libacl1-dev attr

      - name: Restore dependencies
        run: dotnet restore

      - name: Build DeDuBa project (Linux)
        run: dotnet build DeDuBa/DeDuBa.csproj --configuration ${{ matrix.configuration }} --no-restore -r linux-x64

      - name: Run tests
        run: dotnet test DeDuBa.Test/DeDuBa.Test.csproj --configuration ${{ matrix.configuration }} --verbosity normal -r linux-x64
        env:
          LD_LIBRARY_PATH: "${{ github.workspace }}/OsCallsCommonShim/bin/${{ matrix.configuration }}/net8.0:${{ github.workspace }}/OsCallsLinuxShim/bin/${{ matrix.configuration }}/net8.0"

      - name: Package Linux artifacts
        if: matrix.configuration == 'Release'
        run: |
          chmod +x scripts/package.sh
          scripts/package.sh linux-x64 ${{ matrix.configuration }}

      - name: Upload Linux artifacts
        if: matrix.configuration == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: DeDuBa-linux-x64-${{ matrix.configuration }}
          path: |
            dist/DeDuBa-*-linux-x64.tar.gz
          retention-days: 30

  # Windows cross-build (MinGW on Linux)
  build-windows-cross:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Install cross-compile dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build mingw-w64

      - name: Restore dependencies
        run: dotnet restore

      - name: Build Windows shim (cross)
        run: |
          dotnet build OsCallsWindowsShim/OsCallsWindowsShim.csproj \
            --configuration ${{ matrix.configuration }} \
            -r win-x64

      - name: Package Windows artifacts
        if: matrix.configuration == 'Release'
        run: |
          chmod +x scripts/package.sh
          scripts/package.sh win-x64 ${{ matrix.configuration }}

      - name: Upload Windows artifacts
        if: matrix.configuration == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: DeDuBa-win-x64-${{ matrix.configuration }}
          path: |
            dist/DeDuBa-*-win-x64.zip
          retention-days: 30

  # Native Windows build and test (validates on actual Windows)
  build-windows-native:
    runs-on: windows-latest
    strategy:
      matrix:
        configuration: [Debug, Release]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build DeDuBa project (Windows)
        run: dotnet build DeDuBa/DeDuBa.csproj --configuration ${{ matrix.configuration }} --no-restore -r win-x64

      - name: Run tests (Windows)
        run: dotnet test DeDuBa.Test/DeDuBa.Test.csproj --configuration ${{ matrix.configuration }} --verbosity normal -r win-x64

      - name: Smoke test Windows binary
        if: matrix.configuration == 'Release'
        shell: pwsh
        run: |
          dotnet publish DeDuBa/DeDuBa.csproj `
            --configuration ${{ matrix.configuration }} `
            -r win-x64 `
            -p:PublishSingleFile=true `
            -p:SelfContained=true `
            -o dist/smoke-test

          # Try --version to ensure runtime loads
          dist/smoke-test/DeDuBa.exe --help || echo "Help output returned non-zero (expected if no args required)"

  # Consolidate artifacts and prepare for release (runs only on Release builds)
  prepare-release:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    needs: [build-linux, build-windows-cross]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: List downloaded artifacts
        run: |
          echo "=== Downloaded artifacts ==="
          ls -lR artifacts/

      - name: Archive consolidated artifacts
        run: |
          mkdir -p release-staging
          find artifacts/ -name '*.tar.gz' -exec cp {} release-staging/ \;
          find artifacts/ -name '*.zip' -exec cp {} release-staging/ \;
          ls -lh release-staging/

      - name: Upload consolidated release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: DeDuBa-release-all
          path: release-staging/
          retention-days: 90

  # Create GitHub release from artifacts (only on version tags)
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-windows-cross, build-windows-native]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Prepare release files
        run: |
          mkdir -p release-files
          find artifacts/ -name '*.tar.gz' -exec cp {} release-files/ \;
          find artifacts/ -name '*.zip' -exec cp {} release-files/ \;
          echo "=== Release files ==="
          ls -lh release-files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-files/*
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true
          body: |
            ## Downloads

            ### Linux (x64)
            - `DeDuBa-*-linux-x64.tar.gz` - Self-contained Linux binary with native POSIX shims
              - Extract: `tar xzf DeDuBa-*-linux-x64.tar.gz`
              - Run: `./DeDuBa <files-to-backup>`

            ### Windows (x64)
            - `DeDuBa-*-win-x64.zip` - Self-contained Windows binary with native shims
              - Extract to a folder and run `DeDuBa.exe <files-to-backup>`

            ## What's Changed

            See below for automatically generated release notes from commit messages.
            For detailed changes, see [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md).

            ---
